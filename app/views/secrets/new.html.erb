<% content_for :title, "New secret" %>

<h1 style="text-align: center;">New Secret</h1>

<div style="position: relative;">
  <div style="position: absolute; top: 0; left: 0; margin: 10px;">
    <%= link_to "&#x2190;".html_safe, secrets_path, style: "text-decoration: none; font-size: 24px;" %>
  </div>
</div>

<div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
  <div style="flex: 1; min-width: 300px;">
    <%= form_with model: @secret, url: secrets_path, method: :post, local: true do |form| %>
      <div>
        <%= form.label :name, "Name:" %>
        <%= form.text_field :name, style: "width: 100%; margin-top: 5px;" %>
      </div>
      
      <div style="margin-top: 20px;">
        <%= form.label :description, "Description:" %>
        <%= form.text_area :description, rows: 5, style: "width: 100%; margin-top: 5px;" %>
      </div>

      <div style="margin-top: 20px;">
        <p>Select a location on the map:</p>
        <%= form.hidden_field :latitude, id: "latitudeField" %>
        <%= form.hidden_field :longitude, id: "longitudeField" %>
      </div>

      <div style="display: flex; gap: 20px; margin-top: 10px;">
        <div style="flex: 1;">
          <%= form.label :latitude, "Latitude:" %>
          <input type="text" id="latitudeDisplay" readonly style="width: 100%; margin-top: 5px;">
        </div>
        <div style="flex: 1;">
          <%= form.label :longitude, "Longitude:" %>
          <input type="text" id="longitudeDisplay" readonly style="width: 100%; margin-top: 5px;">
        </div>
      </div>

      <div style="margin-top: 20px;">
        <%= form.submit "Create Secret", style: "width: 100%; padding: 10px; background-color: #007BFF; color: white; font-size: 16px;" %>
      </div>
    <% end %>
  </div>

  <div id="map" style="flex: 1; min-width: 300px; height: 300px; border: 1px solid #ccc;"></div>
</div>

<script>
  let map;
  let marker;

  function initMap() {
    const mapElement = document.getElementById("map");
    const latitudeField = document.getElementById("latitudeField");
    const longitudeField = document.getElementById("longitudeField");
    const latitudeDisplay = document.getElementById("latitudeDisplay");
    const longitudeDisplay = document.getElementById("longitudeDisplay");

    const mapOptions = {
      center: { lat: 50.8503, lng: 4.3517 },
      zoom: 14,
    };

    map = new google.maps.Map(mapElement, mapOptions);

    map.addListener("click", (event) => {
      if (marker) {
        marker.setMap(null);
      }

      marker = new google.maps.Marker({
        position: event.latLng,
        map: map,
      });

      const latLng = event.latLng;
      latitudeField.value = latLng.lat().toFixed(6);
      longitudeField.value = latLng.lng().toFixed(6);
      latitudeDisplay.value = latLng.lat().toFixed(6);
      longitudeDisplay.value = latLng.lng().toFixed(6);
    });
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>
